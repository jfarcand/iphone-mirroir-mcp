name: Install

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  install-test:
    runs-on: macos-15
    env:
      MCP_BIN: mirroir-mcp

    steps:
      - uses: actions/checkout@v4

      # --- Build ---

      - name: Build release binaries
        run: swift build -c release

      - name: Verify binary exists and is executable
        run: |
          test -x .build/release/$MCP_BIN || { echo "FAIL: $MCP_BIN not found or not executable"; exit 1; }
          file .build/release/$MCP_BIN
          echo "Binary built successfully."

      # --- MCP binary from build path ---

      - name: Verify MCP binary responds to JSON-RPC initialize
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' \
            | .build/release/$MCP_BIN 2>/dev/null \
            | python3 -c "
          import sys, json
          obj = json.loads(sys.stdin.readline())
          assert obj['result']['serverInfo']['name'] == 'mirroir-mcp'
          print('MCP initialize from build path: OK')
          "
