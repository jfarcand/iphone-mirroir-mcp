name: Installers

on:
  push:
    branches: [main, 'feature/**']
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  source-install:
    name: Source install (mirroir.sh)
    runs-on: macos-15
    env:
      MIRROIR_BUNDLE_ID: com.jfarcand.FakeMirroring
      MIRROIR_PROCESS_NAME: FakeMirroring
    steps:
      - uses: actions/checkout@v4

      - name: Run mirroir.sh
        run: ./mirroir.sh

      - name: Verify binaries built
        run: |
          test -x .build/release/mirroir-mcp
          # Verify mirroir CLI symlink was created (Homebrew bin dir)
          test -L /opt/homebrew/bin/mirroir || test -L /usr/local/bin/mirroir
          mirroir record --help 2>&1 | grep -q "Record user interactions"

      - name: Build and package FakeMirroring
        run: |
          swift build -c release --product FakeMirroring
          ./scripts/package-fake-app.sh

      - name: Launch FakeMirroring
        run: |
          open .build/release/FakeMirroring.app
          sleep 3

      - name: Integration tests (FakeMirroring)
        run: swift test --filter IntegrationTests

      - name: MCP initialize (installed binary)
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' \
            | .build/release/mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          obj = json.loads(sys.stdin.readline())
          assert obj['result']['serverInfo']['name'] == 'mirroir-mcp'
          print('MCP initialize: OK')
          "

      - name: MCP tools/call screenshot (installed binary + FakeMirroring)
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"screenshot","arguments":{}}}\n' \
            | .build/release/mirroir-mcp --dangerously-skip-permissions 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          resp = json.loads(lines[1])
          content = resp['result']['content']
          images = [c for c in content if c.get('type') == 'image']
          assert len(images) > 0, f'Expected image in screenshot response, got: {content}'
          print(f'screenshot tool: OK ({len(images)} image block(s))')
          "

  homebrew-install:
    name: Homebrew install (local formula)
    runs-on: macos-15
    env:
      MIRROIR_BUNDLE_ID: com.jfarcand.FakeMirroring
      MIRROIR_PROCESS_NAME: FakeMirroring
    steps:
      - uses: actions/checkout@v4

      - name: Create source tarball
        run: |
          TAR_PATH="/tmp/mirroir-mcp-local.tar.gz"
          git archive --format=tar.gz --prefix=mirroir-mcp-local/ HEAD > "$TAR_PATH"
          SHA=$(shasum -a 256 "$TAR_PATH" | cut -d' ' -f1)
          echo "TARBALL_PATH=$TAR_PATH" >> $GITHUB_ENV
          echo "TARBALL_SHA=$SHA" >> $GITHUB_ENV

      - name: Create local tap with formula
        run: |
          brew tap-new local/test
          TAP_DIR="$(brew --repository)/Library/Taps/local/homebrew-test/Formula"
          mkdir -p "$TAP_DIR"
          cat > "$TAP_DIR/mirroir-mcp.rb" << RUBY
          class MirroirMcp < Formula
            desc "MCP server for controlling iPhone through macOS iPhone Mirroring"
            homepage "https://github.com/jfarcand/mirroir-mcp"
            url "file://${TARBALL_PATH}"
            version "0.0.0-ci"
            sha256 "${TARBALL_SHA}"
            license "Apache-2.0"

            depends_on :macos
            depends_on xcode: ["15.0", :build]

            def install
              system "swift", "build", "-c", "release", "--disable-sandbox"
              bin.install ".build/release/mirroir-mcp"
              bin.install_symlink "mirroir-mcp" => "mirroir"
            end

            test do
              assert_match "mirroir-mcp", shell_output("#{bin}/mirroir-mcp --help 2>&1", 1)
            end
          end
          RUBY

      - name: Install from local tap
        run: brew install local/test/mirroir-mcp

      - name: Verify Homebrew-installed binaries
        run: |
          which mirroir-mcp
          which mirroir
          # Verify mirroir CLI works (symlink to mirroir-mcp)
          mirroir test --help 2>&1 | grep -q "mirroir-mcp test"

      - name: Build and package FakeMirroring
        run: |
          swift build -c release --product FakeMirroring
          ./scripts/package-fake-app.sh

      - name: Launch FakeMirroring
        run: |
          open .build/release/FakeMirroring.app
          sleep 3

      - name: Integration tests (FakeMirroring)
        run: swift test --filter IntegrationTests

      - name: MCP initialize (brew-installed binary)
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' \
            | mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          obj = json.loads(sys.stdin.readline())
          assert obj['result']['serverInfo']['name'] == 'mirroir-mcp'
          print('MCP initialize (brew path): OK')
          "

      - name: MCP tools/call screenshot (brew-installed binary + FakeMirroring)
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"screenshot","arguments":{}}}\n' \
            | mirroir-mcp --dangerously-skip-permissions 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          resp = json.loads(lines[1])
          content = resp['result']['content']
          images = [c for c in content if c.get('type') == 'image']
          assert len(images) > 0, f'Expected image in screenshot response, got: {content}'
          print(f'screenshot tool: OK ({len(images)} image block(s))')
          "

      - name: Cleanup
        if: always()
        run: |
          sudo brew uninstall mirroir-mcp || true

  npx-install:
    name: NPX install (npm package)
    runs-on: macos-15
    env:
      MIRROIR_BUNDLE_ID: com.jfarcand.FakeMirroring
      MIRROIR_PROCESS_NAME: FakeMirroring
    steps:
      - uses: actions/checkout@v4

      - name: Build release binaries
        run: swift build -c release

      - name: Stage binaries into npm/bin/ (simulates install.js postinstall)
        run: |
          mkdir -p npm/bin
          cp .build/release/mirroir-mcp npm/bin/mirroir-mcp-native
          chmod +x npm/bin/mirroir-mcp-native

      - name: Build and package FakeMirroring
        run: |
          swift build -c release --product FakeMirroring
          ./scripts/package-fake-app.sh

      - name: Launch FakeMirroring
        run: |
          open .build/release/FakeMirroring.app
          sleep 3

      - name: Integration tests (FakeMirroring)
        run: swift test --filter IntegrationTests

      - name: MCP initialize (npx wrapper)
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' \
            | node npm/bin/mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          obj = json.loads(sys.stdin.readline())
          assert obj['result']['serverInfo']['name'] == 'mirroir-mcp'
          print('MCP initialize (npx wrapper): OK')
          "

      - name: MCP tools/call screenshot (npx wrapper + FakeMirroring)
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"screenshot","arguments":{}}}\n' \
            | node npm/bin/mirroir-mcp --dangerously-skip-permissions 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          resp = json.loads(lines[1])
          content = resp['result']['content']
          images = [c for c in content if c.get('type') == 'image']
          assert len(images) > 0, f'Expected image in screenshot response, got: {content}'
          print(f'screenshot tool: OK ({len(images)} image block(s))')
          "
